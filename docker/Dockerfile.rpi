# =============================================================================
# Multi-stage Dockerfile for Hokuyo Hub - Raspberry Pi ARM64 Build
# =============================================================================
# This Dockerfile implements the Phase 3 Docker/CI/CD approach for building
# Hokuyo Hub targeting Raspberry Pi ARM64 architecture.
#
# Build stages:
# 1. build-deps: Install build dependencies and tools
# 2. build-app: Build the application with unified dependency management
# 3. runtime: Minimal runtime image with only necessary components
#
# Usage:
#   docker buildx build --platform linux/arm64 -f docker/Dockerfile.rpi -t hokuyo-hub:rpi .
#   docker buildx build --platform linux/arm64 -f docker/Dockerfile.rpi --target build-app -t hokuyo-hub:build .

# =============================================================================
# Stage 1: Build Dependencies
# =============================================================================
FROM --platform=linux/arm64 debian:bookworm-slim AS build-deps

# Install build dependencies
RUN apt-get update && apt-get install -y \
    # Build essentials
    build-essential \
    cmake \
    ninja-build \
    pkg-config \
    git \
    file \
    # C++ dependencies available in Debian Bookworm
    # CrowCpp requires minimal system dependencies compared to the previous web framework
    libyaml-cpp-dev \
    libnng-dev \
    # Dependencies for CrowCpp (header-only, but needs these at runtime)
    libssl-dev \
    zlib1g-dev \
    # Note: CrowCpp is header-only and uses asio (included), so fewer deps needed
    libuuid1 \
    uuid-dev \
    libasio-dev \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

# Verify installed packages
# Verify installed packages
RUN echo "=== Installed Package Versions ===" && \
    dpkg -l | grep -E "(libyaml-cpp|libnng)" && \
    echo "=== CMake Version ===" && \
    cmake --version && \
    echo "=== GCC Version ===" && \
    gcc --version

# =============================================================================
# Stage 2: Application Build
# =============================================================================
FROM build-deps AS build-app

# Set working directory
WORKDIR /build

# Copy source code
COPY . .

# Configure build environment for container
# Use system packages for available dependencies (CrowCpp is header-only)
ENV DEPS_MODE=auto
ENV DEPS_CROWCPP=system
ENV DEPS_YAMLCPP=system
ENV DEPS_NNG=system
ENV DEPS_URG=bundled
ENV HOKUYO_NNG_ENABLE=ON
ENV USE_OSC=ON

# Rebuild URG library for Linux ARM64
RUN echo "=== Rebuilding URG Library for Linux ARM64 ===" && \
    cd external/urg_library/current && \
    make clean && \
    make && \
    mkdir -p /build/build/linux-arm64/third_party/urg_library/include && \
    mkdir -p /build/build/linux-arm64/third_party/urg_library/lib && \
    cp -r include/* /build/build/linux-arm64/third_party/urg_library/include/ && \
    cp src/liburg_c.a /build/build/linux-arm64/third_party/urg_library/lib/ && \
    echo "URG library rebuilt successfully for linux-arm64"

# Create build directory and configure
RUN mkdir -p build/linux-arm64

# Configure CMake with system dependencies and CrowCpp
# CrowCpp is header-only and requires minimal configuration
RUN cd build/linux-arm64 && \
    cmake ../.. \
    -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DDEPS_MODE=auto \
    -DDEPS_CROWCPP=system \
    -DDEPS_YAMLCPP=system \
    -DDEPS_NNG=system \
    -DDEPS_URG=bundled \
    -DHOKUYO_NNG_ENABLE=ON \
    -DUSE_OSC=ON \
    -DCMAKE_INSTALL_PREFIX=/opt/hokuyohub \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
    -DCMAKE_CXX_FLAGS="-O2" \
    -DCMAKE_C_FLAGS="-O2"

# Build the application (CrowCpp header-only compilation is much faster)
RUN cd build/linux-arm64 && \
    ninja -v -j$(nproc) hokuyo_hub

# Install to staging area
RUN cd build/linux-arm64 && \
    DESTDIR=/staging ninja install

# Verify build output
RUN echo "=== Build Verification ===" && \
    file build/linux-arm64/bin/hokuyo_hub && \
    ldd build/linux-arm64/bin/hokuyo_hub && \
    ls -la /staging/opt/hokuyohub/

# =============================================================================
# Stage 3: Runtime Image
# =============================================================================
FROM --platform=linux/arm64 debian:bookworm-slim AS runtime

# Install runtime dependencies only
RUN apt-get update && apt-get install -y \
    # Runtime libraries for application dependencies
    libyaml-cpp0.7 \
    libnng1 \
    # System libraries for CrowCpp (minimal runtime dependencies)
    libssl3 \
    zlib1g \
    # System utilities
    ca-certificates \
    curl \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

# Create application user
RUN groupadd -r hokuyo && useradd -r -g hokuyo hokuyo

# Copy application from build stage
COPY --from=build-app /staging/opt/hokuyohub /opt/hokuyohub

# Set ownership
RUN chown -R hokuyo:hokuyo /opt/hokuyohub

# Create data directory
RUN mkdir -p /var/lib/hokuyo-hub && \
    chown hokuyo:hokuyo /var/lib/hokuyo-hub

# Switch to application user
USER hokuyo

# Set working directory
WORKDIR /opt/hokuyohub

# Expose default ports
EXPOSE 8080 8081

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/api/health || exit 1

# Default command
CMD ["./hokuyo_hub"]

# =============================================================================
# Metadata
# =============================================================================
LABEL maintainer="Hokuyo Hub Team"
LABEL description="Hokuyo Hub - Raspberry Pi ARM64 Runtime"
LABEL version="1.0.0"
LABEL architecture="arm64"
LABEL target="raspberry-pi-5"