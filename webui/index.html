<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- head 内のどこか（既存の <script> より前でも後でもOK）に追加 -->
  <link rel="stylesheet" href="./styles.css">
  <title>hokuyo-hub</title>
</head>
<body>
  <header>hokuyo-hub (MVP)</header>
  <div id="stats" class="stats">
    <span id="connection-status">connecting...</span>
    <span id="seq-info"></span>
    <span id="last-seq-age"></span>
    <span id="fps-info"></span>
  </div>
  
  <!-- Viewport and ROI Controls - Hidden for rollback capability -->
  <div id="viewport-controls" class="viewport-controls" style="display: none;">
    <div class="control-group">
      <label>Viewport:</label>
      <button id="btn-reset-viewport-old" type="button" title="Reset View (Double-click canvas)">Reset View</button>
      <span id="viewport-info-old">Scale: 60px/m</span>
    </div>
    <div class="control-group">
      <label>ROI:</label>
      <button id="btn-create-include-old" type="button" class="roi-btn">+ Include Region</button>
      <button id="btn-create-exclude-old" type="button" class="roi-btn">+ Exclude Region</button>
      <button id="btn-clear-roi-old" type="button" class="roi-btn">Clear All ROI</button>
    </div>
    <div class="control-group">
      <label>Config:</label>
      <button id="btn-save-default" type="button" class="roi-btn" title="Save current configuration to default.yaml">Save</button>
      <button id="btn-save-config" type="button" class="roi-btn" title="Save current configuration with custom name">Save As...</button>
      <button id="btn-load-config" type="button" class="roi-btn">Load</button>
      <button id="btn-export-config" type="button" class="roi-btn">Export</button>
      <button id="btn-import-config" type="button" class="roi-btn">Import</button>
    </div>
    <div class="control-group">
      <label>Instructions:</label>
      <span id="roi-instructions-old">Pan: Drag | Zoom: Wheel | Sensors: Drag to move, R to rotate | ROI: Click points, Enter to finish</span>
    </div>
  </div>
  
  <!-- Main 3-column layout -->
  <div id="main-container" class="main-container">
    <!-- Left sidebar -->
    <aside id="sidebar-left" class="sidebar-left">
      <section id="sensors-panel">
        <div class="panel-header">
          <h2>Sensors</h2>
          <button id="btn-refresh" type="button">Refresh</button>
          <button id="btn-add-sensor" type="button" class="btn-primary">Add Sensor</button>
          <span id="panel-msg" class="panel-msg"></span>
        </div>

        <!-- Display controls moved to canvas overlay -->

        <div id="legend" class="legend" hidden>
          <h4>Sensor Legend</h4>
          <div id="legend-items" class="legend-items"></div>
        </div>

        <div class="table-wrap">
          <table id="sensor-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Enabled</th>
                <th>tx</th>
                <th>ty</th>
                <th>theta</th>
                <th style="text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="sensor-tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Sinks Configuration Section -->
      <section id="sinks-panel">
        <div class="panel-header">
          <h2>Sinks</h2>
          <button id="btn-add-sink" type="button" class="btn-primary">Add Sink</button>
          <span id="sinks-msg" class="panel-msg"></span>
        </div>

        <div class="table-wrap">
          <table id="sinks-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Enabled</th>
                <th>URL</th>
                <th>Topic</th>
                <th>Encoding</th>
                <th>Rate Limit (Hz)</th>
                <th style="text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="sinks-tbody"></tbody>
          </table>
        </div>
      </section>
    </aside>

    <!-- Center canvas area -->
    <main id="center-canvas" class="center-canvas">
      <!-- Canvas overlay with controls -->
      <div class="canvas-overlay">
        <div class="overlay-row">
          <label class="control-item">
            <input type="checkbox" id="show-raw-points">
            <span>Show Raw Points</span>
          </label>
          <label class="control-item">
            <input type="checkbox" id="show-filtered-data">
            <span>Show Filtered Data</span>
          </label>
          <label class="control-item">
            <input type="checkbox" id="per-sensor-colors">
            <span>Per-sensor Colors</span>
          </label>
        </div>
        <div class="overlay-row">
          <button id="btn-reset-viewport" type="button" title="Reset View (Double-click canvas)">Reset View</button>
          <span id="viewport-info">Scale: 60px/m</span>
        </div>
        <div class="overlay-row">
          <button id="btn-create-include" type="button" class="roi-btn">+ Include Region</button>
          <button id="btn-create-exclude" type="button" class="roi-btn">+ Exclude Region</button>
          <button id="btn-clear-roi" type="button" class="roi-btn">Clear All ROI</button>
        </div>
        <div class="overlay-row help">
          <span id="roi-instructions">Pan: Drag | Zoom: Wheel | Sensors: Drag to move, R to rotate | ROI: Click points, Enter to finish</span>
        </div>
      </div>
      <canvas id="cv"></canvas>
    </main>

    <!-- Right sidebar -->
    <aside id="sidebar-right" class="sidebar-right">
      <!-- DBSCAN Configuration Section -->
      <section id="dbscan-panel">
        <div class="panel-header">
          <h2>DBSCAN Configuration</h2>
          <span id="dbscan-msg" class="panel-msg"></span>
        </div>

        <div class="dbscan-config">
          <div class="param-row">
            <label>eps_norm:</label>
            <input type="number" id="dbscan-eps-norm" min="0.1" max="10.0" step="0.1" value="2.5">
          </div>
          <div class="param-row">
            <label>minPts:</label>
            <input type="number" id="dbscan-min-pts" min="1" max="100" value="5">
          </div>
          <div class="param-row">
            <label>k_scale:</label>
            <input type="number" id="dbscan-k-scale" min="0.1" max="10.0" step="0.1" value="1.0">
          </div>
          <div class="param-row">
            <label>h_min (m):</label>
            <input type="number" id="dbscan-h-min" min="0.001" max="1.0" step="0.001" value="0.01">
          </div>
          <div class="param-row">
            <label>h_max (m):</label>
            <input type="number" id="dbscan-h-max" min="0.001" max="1.0" step="0.001" value="0.20">
          </div>
          <div class="param-row">
            <label>R_max:</label>
            <input type="number" id="dbscan-r-max" min="1" max="50" value="5">
          </div>
          <div class="param-row">
            <label>M_max:</label>
            <input type="number" id="dbscan-m-max" min="10" max="5000" value="600">
          </div>
        </div>
      </section>

      <!-- Filter Configuration Section -->
      <section id="filter-panel">
        <div class="panel-header">
          <h2>Filter Configuration</h2>
          <button id="btn-reset-filters" type="button">Reset to Default</button>
          <span id="filter-msg" class="panel-msg"></span>
        </div>

        <div class="filter-config">
  <!-- Prefilter Configuration -->
  <div class="filter-section">
   <h3 tabindex="0" role="button" aria-expanded="true" aria-controls="prefilter-content">
    <label class="control-item">
     <input type="checkbox" id="prefilter-enabled" checked>
     <span>Prefilter</span>
    </label>
    <span class="toggle-caret">▼</span>
   </h3>
   
   <div class="filter-content" id="prefilter-content">
    <div class="filter-strategies" id="prefilter-strategies">
				<!-- Neighborhood Filter -->
				<div class="strategy-group">
					<h4 tabindex="0" role="button" aria-expanded="true" aria-controls="prefilter-neighborhood-params">
						<label class="control-item">
							<input type="checkbox" id="prefilter-neighborhood-enabled" checked>
							<span>Neighborhood Filter</span>
						</label>
						<span class="toggle-caret">▼</span>
					</h4>
					<div class="strategy-params" id="prefilter-neighborhood-params">
						<div class="param-row">
							<label>Min Neighbors (k):</label>
							<input type="number" id="prefilter-neighborhood-k" min="1" max="20" value="5">
						</div>
						<div class="param-row">
							<label>Base Radius (m):</label>
							<input type="number" id="prefilter-neighborhood-r-base" min="0.001" max="1.0" step="0.001" value="0.05">
						</div>
						<div class="param-row">
							<label>Radius Scale:</label>
							<input type="number" id="prefilter-neighborhood-r-scale" min="0.1" max="5.0" step="0.1" value="1.0">
						</div>
					</div>
				</div>

				<!-- Spike Removal Filter -->
				<div class="strategy-group">
					<h4 tabindex="0" role="button" aria-expanded="true" aria-controls="prefilter-spike-params">
						<label class="control-item">
							<input type="checkbox" id="prefilter-spike-enabled" checked>
							<span>Spike Removal</span>
						</label>
						<span class="toggle-caret">▼</span>
					</h4>
					<div class="strategy-params" id="prefilter-spike-params">
						<div class="param-row">
							<label>dR/dθ Threshold:</label>
							<input type="number" id="prefilter-spike-dr-threshold" min="0.1" max="2.0" step="0.1" value="0.3">
						</div>
						<div class="param-row">
							<label>Window Size:</label>
							<input type="number" id="prefilter-spike-window-size" min="1" max="10" value="3">
						</div>
					</div>
				</div>

				<!-- Outlier Removal Filter -->
				<div class="strategy-group">
					<h4 tabindex="0" role="button" aria-expanded="true" aria-controls="prefilter-outlier-params">
						<label class="control-item">
							<input type="checkbox" id="prefilter-outlier-enabled" checked>
							<span>Outlier Removal</span>
						</label>
						<span class="toggle-caret">▼</span>
					</h4>
					<div class="strategy-params" id="prefilter-outlier-params">
						<div class="param-row">
							<label>Median Window:</label>
							<input type="number" id="prefilter-outlier-median-window" min="1" max="20" value="5">
						</div>
						<div class="param-row">
							<label>Outlier Threshold (σ):</label>
							<input type="number" id="prefilter-outlier-threshold" min="0.5" max="5.0" step="0.1" value="2.0">
						</div>
					</div>
				</div>

				<!-- Intensity Filter -->
				<div class="strategy-group">
					<h4 tabindex="0" role="button" aria-expanded="true" aria-controls="prefilter-intensity-params">
						<label class="control-item">
							<input type="checkbox" id="prefilter-intensity-enabled">
							<span>Intensity Filter</span>
						</label>
						<span class="toggle-caret">▼</span>
					</h4>
					<div class="strategy-params" id="prefilter-intensity-params">
						<div class="param-row">
							<label>Min Intensity:</label>
							<input type="number" id="prefilter-intensity-min" min="0" max="1000" value="0">
						</div>
						<div class="param-row">
							<label>Min Reliability:</label>
							<input type="number" id="prefilter-intensity-reliability" min="0" max="1" step="0.01" value="0">
						</div>
					</div>
				</div>

				<!-- Isolation Removal Filter -->
				<div class="strategy-group">
					<h4 tabindex="0" role="button" aria-expanded="true" aria-controls="prefilter-isolation-params">
						<label class="control-item">
							<input type="checkbox" id="prefilter-isolation-enabled" checked>
							<span>Isolation Removal</span>
						</label>
						<span class="toggle-caret">▼</span>
					</h4>
					<div class="strategy-params" id="prefilter-isolation-params">
						<div class="param-row">
							<label>Min Cluster Size:</label>
							<input type="number" id="prefilter-isolation-min-size" min="1" max="20" value="3">
						</div>
						<div class="param-row">
							<label>Isolation Radius (m):</label>
							<input type="number" id="prefilter-isolation-radius" min="0.01" max="1.0" step="0.01" value="0.1">
						</div>
					</div>
				</div>
				</div>
			</div>
		</div>

		<!-- Postfilter Configuration -->
		<div class="filter-section">
			<h3 tabindex="0" role="button" aria-expanded="true" aria-controls="postfilter-content">
				<label class="control-item">
					<input type="checkbox" id="postfilter-enabled" checked>
					<span>Postfilter</span>
				</label>
				<span class="toggle-caret">▼</span>
			</h3>
			
			<div class="filter-content" id="postfilter-content">
				<div class="filter-strategies" id="postfilter-strategies">
				<!-- Cluster Isolation Removal -->
				<div class="strategy-group">
					<h4 tabindex="0" role="button" aria-expanded="true" aria-controls="postfilter-isolation-params">
						<label class="control-item">
							<input type="checkbox" id="postfilter-isolation-enabled" checked>
							<span>Cluster Isolation Removal</span>
						</label>
						<span class="toggle-caret">▼</span>
					</h4>
					<div class="strategy-params" id="postfilter-isolation-params">
						<div class="param-row">
							<label>Min Points Size:</label>
							<input type="number" id="postfilter-isolation-min-size" min="1" max="50" value="3">
						</div>
						<div class="param-row">
							<label>Isolation Radius (m):</label>
							<input type="number" id="postfilter-isolation-radius" min="0.001" max="2.0" step="0.001" value="0.2">
						</div>
						<div class="param-row">
							<label>Required Neighbors:</label>
							<input type="number" id="postfilter-isolation-required-neighbors" min="1" max="20" value="1">
							</div>
						</div>
					</div>
						     </div>
			</div>
		</div>
	       </div>
	     </section>
	   </aside>
	 </div>

<!-- Modals and other elements -->
<div id="sensor-modal-backdrop" class="modal-backdrop" hidden></div>
<div id="sensor-modal" class="modal" hidden aria-modal="true" role="dialog">
  <div class="modal__header">
    <h3 id="sensor-modal-title">Sensor Details</h3>
    <button id="sensor-modal-close" class="btn btn-ghost" aria-label="Close">×</button>
  </div>
  <div class="modal__body" id="sensor-modal-body">
    <!-- 動的に項目を生成します -->
  </div>
  <div class="modal__footer">
    <button id="sensor-modal-cancel" class="btn">Cancel</button>
    <button id="sensor-modal-save" class="btn btn-primary">Save</button>
  </div>
</div>

<!-- Hidden file input for config import -->
<input type="file" id="config-file-input" accept=".yaml,.yml,text/yaml,text/plain" style="display: none;">

<script src="app.js"></script>
</body>
</html>