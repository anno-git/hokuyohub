# 実装計画: ズームの範囲を変える

目的
- 小規模/大規模シーンの双方に対応できるよう、キャンバスのズーム範囲を拡張する。
- 現状の 10〜200 px/m を、例として 5〜400 px/m に拡張する（最終値は運用で調整可）。

対象
- ホイールズームとキーボード + / - の両方のクランプ範囲を調整。
  - ホイールズーム: [cv.addEventListener('wheel', ...)](webui/app.js:2055)
  - キー操作 + / -: [document.addEventListener('keydown', ...)](webui/app.js:2083)

現状の把握
- ホイールズームでのクランプ:
  - newScale = Math.max(10, Math.min(200, viewport.scale * zoomFactor))
  - 実装箇所: [webui/app.js](webui/app.js:2063)
- キーボード + / - でのクランプ:
  - +/=: viewport.scale = Math.min(200, viewport.scale * 1.1)
    - 実装箇所: [webui/app.js](webui/app.js:2106)
  - -: viewport.scale = Math.max(10, viewport.scale * 0.9)
    - 実装箇所: [webui/app.js](webui/app.js:2111)
- ビューポート情報表示は以下で更新される（スケール値のレンジ変更の影響はない）。
  - [updateViewportInfo()](webui/app.js:2338)

変更方針
- クランプの下限/上限を 10→5、200→400 に変更。
- ズームレンジ拡張に伴い、グリッド/ラベルの可読性を確認（必要なら `chooseGridStepMeters` の最小ラベル間隔調整）。
  - ラベル間隔のロジック: [chooseGridStepMeters()](webui/app.js:340)

具体手順
1) ホイールズームの上下限を変更
   - 対象: [webui/app.js](webui/app.js:2063)
   - 修正案:
     - const newScale = Math.max(5, Math.min(400, viewport.scale * zoomFactor));

2) キーボード + / - の上下限を変更
   - 対象: [webui/app.js](webui/app.js:2106), [webui/app.js](webui/app.js:2111)
   - 修正案:
     - '+/=': viewport.scale = Math.min(400, viewport.scale * 1.1);
     - '-':   viewport.scale = Math.max(5, viewport.scale * 0.9);

3) グリッド表示の確認（必要に応じて微調整）
   - 低ズーム時(5 px/m)にグリッド線が過密/過疎にならないか確認。必要ならラベルの最小距離を `minLabelPx` で調整。
     - 対象: [chooseGridStepMeters()](webui/app.js:340)
     - 例: const minLabelPx = 80; → 60〜100 の範囲で適宜調整。初回は現状維持で検証。

4) 表示情報の挙動確認
   - [updateViewportInfo()](webui/app.js:2338) は scale と m/px を表示する。レンジ拡張の影響なし。
   - ダブルクリック/リセットは 60 px/m に戻る既定。必要であれば小型画面向けに 80 等へ将来調整可能（今回は変更しない）。
     - dblclick reset: [webui/app.js](webui/app.js:2075)
     - Resetボタン: [webui/app.js](webui/app.js:2250)

受け入れ基準（テスト観点）
- ホイールズームで 5〜400 px/m の範囲にクランプされる。
  - 最小側: 長押し/大回転で 5 px/m を下回らない。
  - 最大側: 400 px/m を超えない。
- キーボード +/ - でも同レンジに収まる。
- グリッドとラベルが可読範囲に保たれる（初回は現状の `minLabelPx=80` で確認）。
- Reset View（ボタン/dblclick）後も、ズーム操作で拡張レンジが有効。

非機能・パフォーマンス
- 極端な拡大(400 px/m)時は描画負荷が相対的に増えるが、キャンバス内点数は同じであり描画パスは変化ない。
- 極端な縮小(5 px/m)時は画面内点群が密集。当該時は [performanceMode](webui/app.js:311) の活用をユーザヘルプに追記してもよい（任意）。

リスクと対処
- 既存のセンター起点ズームで、極端なスケール変化時にパンオフセット調整が直感とズレる場合がある。
  - 必要に応じてマウス座標へのスケーリング補正（現状実装済）を再確認: [zoom towards mouse position](webui/app.js:2065)
- 将来、端末幅に応じて最大ズームを制限したい場合はレスポンシブ閾値での条件分岐を検討。

ロールバック手順
- 下限/上限を元の 10/200 に戻す。

作業粒度・変更規模
- 小（フロントエンドのみ、定数調整3箇所程度）。

関連ファイル（参照）
- ホイールズーム: [webui/app.js](webui/app.js:2055)
- クランプ式: [webui/app.js](webui/app.js:2063)
- キー操作のクランプ: [webui/app.js](webui/app.js:2106), [webui/app.js](webui/app.js:2111)
- グリッド刻み算出: [webui/app.js](webui/app.js:340)
- ビューポート情報表示: [webui/app.js](webui/app.js:2338)

想定工数
- 実装・セルフテスト: 0.5h
- コードレビュー・微修正: 0.5h