# 実装計画: フィルタの初期値を決める

目的
- 初期フィルタ設定（Prefilter/Postfilter）の「単一の正」をサーバ側（AppConfig/FilterManager）に集約し、WebUIは接続時にサーバ配布値をそのまま反映する。
- UIボタンによる独自の「デフォルト初期化」は廃止し、設定の一貫性と運用性を高める（Resetボタン削除は別計画 10 にて実施）。

対象
- WebSocket 側の配布/更新経路
  - [sendFilterConfigTo()](src/io/ws_handlers.cpp:472)
  - [handleFilterUpdate()](src/io/ws_handlers.cpp:425)
  - [broadcastFilterConfigUpdate()](src/io/ws_handlers.cpp:457)
- WebUI の受信/適用/送信
  - 受信適用 [applyFilterConfigToUI()](webui/app.js:1522)
  - 変更送信 [sendFilterConfig()](webui/app.js:1557)
  - 初期要求（接続/ボタン）[ws.send filter.requestConfig](webui/app.js:1152)
- FilterManager API
  - 取得 [getFilterConfigAsJson()](src/core/filter_manager.h:22)
  - 更新 [updateFilterConfig()](src/core/filter_manager.h:17)
  - 再読込 [reloadFromAppConfig()](src/core/filter_manager.h:36)

現状の把握
- クライアントは接続時に `filter.requestConfig` を送出（[webui/app.js](webui/app.js:1152)）し、サーバは [sendFilterConfigTo()](src/io/ws_handlers.cpp:472) で `filter.config` を返す。
- UIは `filter.config`/`filter.updated` を受けて [applyFilterConfigToUI()](webui/app.js:1522) でフォーム同期する。
- UI側に「暫定の初期値（currentFilterConfig）」がハードコードされている（[webui/app.js](webui/app.js:1429)）。実際は接続直後の `filter.config` で上書きされる前提。
- サーバ側は [updateFilterConfig()](src/core/filter_manager.h:17) 経由で設定を受け取り、[broadcastFilterConfigUpdate()](src/io/ws_handlers.cpp:457) で全クライアントへ反映できる。

変更方針
- 「初期値の真の出自」をサーバ設定（AppConfig→FilterManager）に一本化する。
- WebUIの初期ハードコード値は「待ち受け用の暫定」であり、接続直後の `filter.config` で確実に置換されることを仕様として明記。
- 既定値の定義は AppConfig（prefilter/postfilter）に保持し、FilterManager の [getFilterConfigAsJson()](src/core/filter_manager.h:22) で完全表現を配布。
- UIの「Reset to Default」ボタンは削除（計画 10）。デフォルトへ戻したい場合は config の保存/ロード機能を使用。

具体手順
1) サーバ側（既存の整合性確認と不足補填）
   - FilterManager が返す JSON に全キーが含まれているか（enabled/各ストラテジの enabled と各パラメータ）をレビュー。
     - 対応コード: [getFilterConfigAsJson()](src/core/filter_manager.h:22) 実装側
   - `updateFilterConfig()` で UI からの JSON を厳密にバリデーション（範囲、型）し、内部構造へ反映。成功時は [broadcastFilterConfigUpdate()](src/io/ws_handlers.cpp:457) で全配布。
   - AppConfig ロード/インポート時に FilterManager へ反映済みかを再確認。
     - 参照: REST 経由設定変更後の再読込（[reloadFromAppConfig()](src/core/filter_manager.h:36) は REST の Load/Import 内で呼ばれている。実装は [rest_handlers.cpp](src/io/rest_handlers.cpp:1197, 1276) 参照）

2) クライアント側（UI）
   - 初期の `currentFilterConfig` は残すが、「接続直後に `filter.config` で完全上書きされる」ことをコメントとして明記。
     - 対象: [webui/app.js](webui/app.js:1429)
   - `DOMContentLoaded` または `ws.open` で `filter.requestConfig` を確実に送出し、競合しないよう既存の実装を維持/整理（[webui/app.js](webui/app.js:1152)）。
   - Resetボタンに依存した UX 文言は削除（別計画 10）。代替動線として Configs Load/Save/Import/Export の利用をヘルプに記載。

3) ドキュメント/仕様化
   - docs に「フィルタ初期値はサーバ側の AppConfig に定義され、UI側の初期値は暫定値である」旨の記載を追加（本書およびREADME等）。
   - 「既定へ戻す」運用手順として、default.yaml をロードする方法を提示。

受け入れ基準（テスト観点）
- サーバ（AppConfig）で Prefilter/Postfilter の既定値を変更し、アプリ起動→WebUI接続時に UI の各項目へ反映される。
  - 確認手順: 接続後に UI 値が AppConfig の値と一致（`filter.config` 受信ログ、[applyFilterConfigToUI()](webui/app.js:1522) の適用結果）。
- UIで値変更→即座に [sendFilterConfig()](webui/app.js:1557) 経由で送信→サーバが [handleFilterUpdate()](src/io/ws_handlers.cpp:425) を受け、[broadcastFilterConfigUpdate()](src/io/ws_handlers.cpp:457) が飛び、他ブラウザにも反映。
- Resetボタンを廃止しても、Configs Load 経由で default.yaml に戻せる（別計画 10 と連動）。

境界・エラーハンドリング
- サーバが `filter.config` を返すまでに UI が編集されうるが、後着の `filter.config` が UI を上書きしないようにする必要がある場合は、
  - 対応策A: 接続後の初回 `filter.config` を受信するまで UI 操作をロック/ディスエーブル（注意喚起表示）。
  - 対応策B: `filter.updated` の `clientId` を拡張し、ローカル編集中の値を尊重。現状は簡便のため A を推奨（任意）。
- サーバ側のバリデーション強化（範囲外値→エラー応答）。UI は [setFilterMessage()](webui/app.js:1444) にエラーメッセージを表示。

非機能・性能
- `filter.config` のペイロードは小さく、起動時1回の配布で負荷は軽微。
- 複数クライアント同時編集時は最後の更新が勝つ。必要性が高まれば ETag/世代管理を別途検討。

ロールバック手順
- UI 初期値を従来の数値に戻す。
- AppConfig の既定値を元の設定へ戻す。
- Resetボタン復活は計画 10 の逆変更。

作業粒度・変更規模
- 小〜中（主にサーバの JSON 完全性/バリデーション確認、UI側はコメント/説明整理が中心）。

関連リンク
- 受信: [sendFilterConfigTo()](src/io/ws_handlers.cpp:472) / 配布: [broadcastFilterConfigUpdate()](src/io/ws_handlers.cpp:457)
- 更新適用: [handleFilterUpdate()](src/io/ws_handlers.cpp:425)
- UI適用: [applyFilterConfigToUI()](webui/app.js:1522)
- UI送信: [sendFilterConfig()](webui/app.js:1557)
- 初期要求: [ws.send filter.requestConfig](webui/app.js:1152)