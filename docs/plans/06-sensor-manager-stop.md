# 06 SensorManager の停止処理 実装方針

概要
- 常駐前提の暫定実装から、安全に停止/再起動できる実装へ拡張します。スレッドの終了同期、デバイスの停止順序、再起動耐性を確保します。

関連箇所
- 集約開始: [SensorManager::start()](src/core/sensor_manager.cpp:230)
- 停止未実装の注記: [コメント](src/core/sensor_manager.cpp:321)
- デバイス停止: [ISensor::stop()](src/sensors/ISensor.h:24)
- スロット管理/状態: 内部 State とスレッド/フラグ管理（start 実装内）

目的
- アプリ終了時や設定リロード時に、センサー集約スレッドを安全に停止し、各デバイスを確実にクローズする。
- stop() が複数回呼ばれても安全（多重停止可）、start()/stop() の順序が入れ替わっても破綻しないようにする。

設計方針
- running フラグの原子更新で停止要求を行い、集約スレッド側のループを抜ける。
- sleep_until のウェイク待ちで停止が遅延しないよう、タイムスライスが長い場合も 1 フレーム以内で反応する（例: 次 tick の前倒し or 条件変数化は将来検討）。
- stop() は join を保証し、join 後にスロット全体の dev->stop() を再確認（二重停止の許容）。
- configure() 中や start()/stop() の競合を防ぐため、状態遷移を最小限のロックもしくは順序制御のみに留める（重い大域ロックは避ける）。

インターフェイス方針
- SensorManager に public: stop() を追加する。
- stop() は冪等（複数回呼ばれても副作用なし）を保証する。
- start() 側で「既に running の場合」の挙動は現状踏襲（ログ/無視）とする。

実装ステップ
1. stop() の追加
   - running.exchange(false) で停止要求。
   - 集約スレッドが joinable のとき join。
   - join 後、全スロットの dev があれば stop() 再呼び出し（念のための二重停止許容）。
   - started フラグのリセット、必要なら最新 Raw のクリア。
2. 集約ループの微調整
   - ループ脱出時のデバイス stop は既に実装済み（start 内のスレッド末尾参照）だが、stop() 主導の二重呼び出しを許容。
   - ループ待機の sleep_until で長時間ブロックの可能性があるが、1/30 秒程度の遅延は許容範囲とする（将来は条件変数化を検討）。
3. main 側からの呼び出し
   - 正常終了時に stop() を呼ぶフックを用意（スコープ外ではあるが、atexit やシグナルハンドラ、もしくはアプリケーションフレームワークのシャットダウンフックを利用）。 
   - ドラゴンの終了フローに合わせて順序を決める（WS/REST 停止→センサー停止→バス停止の順を推奨）。

並行性と安全性
- start()/stop() の同時呼び出しは避ける前提（利用側の契約）。必要であれば軽量ミューテックスで直列化してもよい。
- スロット配列の破棄は stop()/join 完了後に行う。configure() による slots の再構築は stop() 完了後のみ許可する設計とする。

ログ/可観測性
- stop() 呼び出し時に現在の状態（running, thread join 成否, デバイス停止件数）を簡易ログ。
- タイムアウトは基本導入しない（ISensor::stop() がブロックしない前提）。将来、タイムアウト/強制クローズが必要になれば拡張。

テスト観点
- 単体/結合:
  - start()→stop() の順序でクラッシュしない、二重 stop() が安全、stop()→start() の再起動が成功。
  - 集約スレッドが確実に終了し、リソースリークがない。
- 実機/スタブ:
  - デバイス層で stop() がブロックしないこと（Hokuyo 実装の確認: [HokuyoSensorUrg::stop()](src/sensors/hokuyo/HokuyoSensorUrg.cpp:33) は join→close の順で整合）。

拡張余地
- 条件変数での即時ウェイク（停止要求時に sleep を解除）。
- シャットダウン順序の明確化（WS/REST→集約→バス→アプリ終了）。
- フレーム中の安全停止（フレーム境界で停止を保証）。

完了条件
- 明示的に stop() を呼べば常に集約スレッドが終了し、デバイスがクローズされる。
- 連続の start()/stop() 操作で安定して動作する。