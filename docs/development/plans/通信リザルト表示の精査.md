# 実装計画: 通信リザルト表示の精査

目的
- 通信状態（WebSocket/描画更新）の可観測性を高め、異常検知を容易にする。
- 既存のステータス領域に表示する指標を整理・充実させ、閾値の意味をUIで明示する。

対象
- ステータスUI: [webui/index.html](webui/index.html)
- ステータス更新: [updateStatsDisplay()](webui/app.js:112)
- WSイベント: [ws.onopen](webui/app.js:156), [ws.onclose](webui/app.js:161), [ws.onerror](webui/app.js:166), [ws.onmessage](webui/app.js:171)
- FPS算出: [updateFPS()](webui/app.js:141)

現状の把握
- ステータス行には connection-status / seq-info / last-seq-age / fps-info があり、age の色分け（warn/error）も実装済み。
  - DOM: [index.html の #stats 内](webui/index.html:12)
  - 表示更新: [updateStatsDisplay()](webui/app.js:112)
- 接続/切断/エラー回数はカウンタとして保持されている（connectionCount, disconnectionCount, errorCount）が、UIには未表示。
  - 定義: [app.js 冒頭 定義群](webui/app.js:29)

追加・変更方針
- ステータス領域に以下を追加表示する。
  - WS接続回数: connections
  - WS切断回数: disconnects
  - WSエラー回数: errors
- age の閾値の意味（例: >1s warn, >3s error）をヘルプ/ツールチップ等で明示。
- 任意: 直近受信からの経過を示す簡易プログレス（テキストで十分）。
- 表示のレイアウトは1行内で簡潔に（小画面でも折返しで読めるようにCSS調整は別計画に含める）。

具体手順
1) index.html に追加要素を定義
   - 対象: [webui/index.html](webui/index.html)
   - #stats 内に以下の span を追加
     - <span id="ws-connections"></span>
     - <span id="ws-disconnections"></span>
     - <span id="ws-errors"></span>
   - age の説明用 title を last-seq-age に付与（既存要素流用）
     - 例: title="age>1s: warn, >3s: error"

2) app.js: updateStatsDisplay() の拡張
   - 対象: [updateStatsDisplay()](webui/app.js:112)
   - 追加取得:
     - const wsConnEl = document.getElementById('ws-connections');
     - const wsDiscEl = document.getElementById('ws-disconnections');
     - const wsErrEl  = document.getElementById('ws-errors');
   - 表示文言（例）:
     - wsConnEl.textContent = `connections=${connectionCount}`;
     - wsDiscEl.textContent = `disconnects=${disconnectionCount}`;
     - wsErrEl.textContent  = `errors=${errorCount}`;
   - age の title を設定:
     - lastSeqAgeEl.title = 'age>1s: warn, >3s: error';

3) onopen/onclose/onerror のカウントは既存のまま利用
   - 既に [ws.onopen](webui/app.js:156), [ws.onclose](webui/app.js:161), [ws.onerror](webui/app.js:166) でカウント増加と updateStatsDisplay() 呼び出しがある。

4) UI/UX 微調整（任意）
   - 色分け:
     - errors>0 のとき ws-errors に warn 色（または error 色）を適用。
     - disconnects>0 も同様に軽い強調を検討。
   - 小画面での折返し:
     - CSSで #stats 内 span の margin と font-size を微調整（別計画 05 のレスポンシブに含めても良い）。

受け入れ基準（テスト観点）
- 通常状態（接続維持、fps>0、age<=1s）で errors=0, disconnects=0 が表示される。
- ネットワーク遮断→再接続で disconnects が増加、errors も発生すればカウント増。
- age が 1s/3s を跨ぐと warn/error のクラスが正しく適用され、title でも閾値の意味が分かる。
- 負荷時に fps が適切に表示され、seq-info と整合する。

ロールバック手順
- 追加した 3 つの span を index.html から削除。
- app.js の updateStatsDisplay() の追加更新処理を削除。

作業粒度・変更規模
- 小（フロントエンドのみ、DOM要素数点と更新ロジックの追加）。

関連ファイル（参照）
- ステータスDOM: [index.html #stats](webui/index.html:12)
- 更新関数: [updateStatsDisplay()](webui/app.js:112)
- WSイベント: [ws.onopen](webui/app.js:156), [ws.onclose](webui/app.js:161), [ws.onerror](webui/app.js:166)

想定工数
- 実装・セルフテスト: 0.5h
- UI微調整: 0.5h