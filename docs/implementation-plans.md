# HokuyoHub 実装方針集

この文書は、現在のTODO一覧の各項目について実装の方針を示します。具体実装は担当者に委ねます。
作業担当者は実装計画を日本語でdocs/plansディレクトリにmdファイルで作成し、管理者の承認を得てから作業を開始してください。

目次
- REST API関連
- NNGパブリッシャ実装
- OSCパブリッシャ実装
- 点群範囲指定
- ノイズフィルタ実装

---

REST API 関連

背景
- 現在備えているREST APIはほとんどが仮実装か、よくデザインされていない状態である

目的
- ブラウザで行った調整項目のsaveを行う
- 以下の操作をブラウザを使わずに（例えばcurlで）行えるようにする
    - 各センサーの状態のGET
    - 各センサーのON/OFF
    - アプリケーション全体の設定（configs/*.yamlに記載している内容）のload/import/export
        - load: サーバ端末に保存されているファイルの内容を反映
        - import: クライアント端末のファイルをアップロードして反映
        - export: 現在の設定をクライアントにyamlファイルとしてダウンロード

検討事項
- 簡易的なセキュリティを設ける
- payload設計においては、既存のWSとの一貫性を意識する

---

NNG パブリッシャ実装

背景
- 現在はほぼ未実装

目的
- クラスタ情報を外部へ配信可能にする（例: tcp://host:port）。

方針
- USE_NNG 有効時のみ nng_pub0 ソケットを生成し listen ないし dial。
- シリアライズは軽量な MessagePack を想定し、最低限のスキーマに固定。
- 後述するOSC実装と同等の情報が取得できるようにする

---

OSC パブリッシャ実装

背景
- 現在は未実装

目的
- クラスタ情報を外部へ配信可能にする

方針
- ビルド時にUSE_OSCを設定できるようにする
- 送信先はconfigs/*.yamlに記載
- メッセージのフォーマットは未検討
- NNG実装と同等の情報が取得できるようにする

--- 

点群範囲指定

背景
- 例えばタッチスクリーンなど、アプリケーション側で必要な座標範囲が限定されている場合がある
- 現在はセンサーから受信した点群全てをクラスタ判定に使用している

目的
- クラスタ検出を行う範囲を指定できるようにする

方針
- 有効平面を指定する
    - 矩形で指定
    - 任意の数の頂点による多角形で指定
- 有効平面中の無効範囲を指定できる
    - 矩形で指定
    - 任意の数の頂点による多角形で指定

--- 

ノイズフィルタ実装

背景
- センサーから受信するデータに含まれるノイズにより、クラスタ判定の精度が低下している

目的
- 得られた点群からノイズ点を検出し、クラスタ判定アルゴリズムの手前で除外する

方針
- ノイズの性格を分析する
    - 連続するデータ間で距離の値が大きく変化する際に、その間を渡るような点が検出されることがある
- クラスタにのみ関心があるので、1点のみ独立して存在する点はノイズとして除外して良い
- 前後の値と比較して除外するような実装を行う際は、マルチエコー方式を使用する場合があることにも注意する
- センサーからの値にconfidence的な値がある場合はその利用も検討する
